name: Publish Extension & Package
on:
  # push:
  #   tags:
  #     - "v*.*.*"
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  publish:
    permissions:
      contents: write # Required for uploading release assets (ncipollo/release-action)

    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22]

    steps:
      - uses: actions/checkout@v4

      - name: üíæ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: üõ†Ô∏è Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: üíæ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üì¶ Package Extension (.vsix)
        run: |
          pnpm build
          sha256sum *.vsix > `echo *.vsix`.sha256

      - name: üì§ Upload VSIX to GitHub Release
        # uses: ncipollo/release-action@v1.20.0
        # with:
        #   artifacts: "*.vsix" "*.vsix.sha256"
        #   token: ${{ secrets.GITHUB_TOKEN }}
        #   allowUpdates: true # ensures we can update the release with assets
        #   replacesArtifacts: false
        #   tag: ${{ github.event.release.tag_name }}
        # TODO: switch to ncipollo/release-action when it supports updating existing releases
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            *.vsix
            *.vsix.sha256

      - name: üì§ Publish to Open VSX
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToOpenVSX
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}

      - name: üì§ Publish to VS Code Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          registryUrl: https://marketplace.visualstudio.com
          extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
          pat: ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}

      # - name: üì§ Publish to npmjs
      #   run: pnpm publish:npmjs
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPMJS_TOKEN }}

  # add-contributors:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: true
  #     matrix:
  #       node-version: [22]
  #   outputs:
  #     contributors-generated: ${{ steps.generate.outputs.success }}

  #   steps:
  #     - name: üì• Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: üõ†Ô∏è Set up Node.js ${{ matrix.node-version }}
  #       uses: actions/setup-node@v6
  #       with:
  #         node-version: ${{ matrix.node-version }}

  #     - name: üìä Generate Contributors List
  #       id: generate
  #       run: |
  #         # Generate contributors markdown for the current release
  #         echo "üîç Generating contributors for ${{ github.event.release.tag_name }}..."
          
  #         node scripts/generate-release-contributors.js \
  #           --tag ${{ github.event.release.tag_name }} \
  #           --format markdown \
  #           --output release-contributors.md
          
  #         if [ -s "release-contributors.md" ]; then
  #           echo "‚úÖ Contributors generated successfully"
  #           echo "success=true" >> $GITHUB_OUTPUT
  #         else
  #           echo "‚ö†Ô∏è No contributors found"
  #           echo "success=false" >> $GITHUB_OUTPUT
  #         fi
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #     - name: üì§ Update Release with Contributors
  #       if: steps.generate.outputs.success == 'true'
  #       uses: actions/github-script@v7
  #       with:
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #         script: |
  #           const fs = require('fs');
  #           const contributors = fs.readFileSync('release-contributors.md', 'utf8');
            
  #           // Get the current release
  #           const { data: release } = await github.rest.repos.getRelease({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             release_id: context.payload.release.id
  #           });
            
  #           // Check if contributors section already exists
  #           if (release.body && release.body.includes('## Contributors')) {
  #             console.log('‚ÑπÔ∏è Contributors section already exists, skipping update');
  #             return;
  #           }
            
  #           // Append contributors to the release body
  #           const updatedBody = release.body 
  #             ? `${release.body}\n\n---\n\n${contributors}`
  #             : contributors;
            
  #           // Update the release
  #           // await github.rest.repos.updateRelease({
  #           //   owner: context.repo.owner,
  #           //   repo: context.repo.repo,
  #           //   release_id: context.payload.release.id,
  #           //   body: updatedBody
  #           // });
            
  #           console.log('‚úÖ Release updated with contributors list');
  #           console.log( release.body, "\n=:=\n", contributors , "\n=:=\n", context.repo.owner, "@", context.repo.repo, "\n\nupdatedBody=", updatedBody);

  #     - name: üìã Upload Contributors as Artifact
  #       if: steps.generate.outputs.success == 'true'
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-contributors-${{ github.event.release.tag_name }}
  #         path: release-contributors.md
  #         retention-days: 90

  notify-contributors:
    # needs: [add-contributors, publish]
    # if: needs.add-contributors.outputs.contributors-generated == 'true'
    needs: publish
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üí¨ Comment on Related PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = context.payload.release.tag_name;
            
            try {
              // Get the previous tag
              const { data: tags } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                sort: 'created',
                direction: 'desc'
              });
              
              const currentTagIndex = tags.findIndex(t => t.name === tag);
              const previousTag = currentTagIndex < tags.length - 1 ? tags[currentTagIndex + 1]?.name : null;
              
              if (!previousTag) {
                console.log('No previous tag found, this might be the first release');
                return;
              }
              
              // Get commits between previous tag and current tag
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: previousTag,
                head: tag
              });
              
              const commits = comparison.commits;
              const prNumbers = new Set();
              
              // Extract PR numbers from commit messages
              for (const commit of commits) {
                const matches = commit.commit.message.match(/#(\d+)/g);
                if (matches) {
                  matches.forEach(match => prNumbers.add(match.replace('#', '')));
                }
              }
              
              console.log(`Found ${prNumbers.size} PR(s) to notify`);
              
              // Comment on each PR
              for (const prNumber of prNumbers) {
                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(prNumber),
                    body: `üéâ Thank you for your contribution! üôè. This pull request has been included in release [${tag}](${context.payload.release.html_url})`
                  });
                  console.log(`‚úÖ Commented on PR #${prNumber}`);
                } catch (error) {
                  console.log(`‚ö†Ô∏è Could not comment on PR #${prNumber}: ${error.message}`);
                }
              }
            } catch (error) {
              console.error(`Error in notification job: ${error.message}`);
            }
